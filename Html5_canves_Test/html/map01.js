//瓦片地图编辑器获取到的数据
var map={
    "data":[0, 1, 7, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 7, 7, 0, 2, 8, 0, 0, 0, 0, 0, 0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 7, 7, 0, 8, 8, 0, 0, 14, 20, 20, 20, 8, 0, 18, 0, 6, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 7, 7, 0, 8, 8, 0, 0, 20, 20, 20, 20, 8, 0, 18, 0, 12, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 9, 9, 0, 0, 0, 0, 0, 20, 20, 20, 20, 8, 0, 18, 0, 12, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 9, 9, 0, 15, 9, 9, 0, 4, 10, 10, 10, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 9, 9, 0, 9, 9, 9, 0, 10, 10, 10, 10, 0, 0, 18, 18, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 9, 9, 0, 9, 9, 9, 0, 14, 20, 20, 8, 8, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 9, 9, 0, 9, 9, 9, 0, 20, 20, 20, 8, 8, 0, 18, 0, 15, 9, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 9, 9, 0, 0, 0, 0, 0, 20, 20, 20, 8, 8, 0, 18, 0, 9, 9, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 9, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 0, 9, 9, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 9, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 0, 9, 9, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 21, 0, 0, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    
    "height":30,
    "width":30
};
var properties =
    {
        "0":
        {
            "bordercolor":"rgba(76, 181, 216, 1)",
            "color":"rgba(76, 181, 216, 0.2)",
            "height":"4",
            "imageurl":"image/Toilet.png",
            "textcolor":"black",
            "title":"Toilet",
            "width":"3",
            "x":"0",
            "y":"0"
        },
        "1":
        {
            "bordercolor":"rgba(230, 110, 250, 1)",
            "color":"rgba(230, 110, 250, 0.2)",
            "height":"3",
            "imageurl":"image/McDonald's.png",
            "textcolor":"black",
            "title":"MD",
            "width":"2",
            "x":"0",
            "y":"0"
        },
        "13":
        {
            "bordercolor":"rgba(220, 169, 105, 1)",
            "color":"rgba(220, 169, 105, 0.1)",
            "height":"3",
            "imageurl":"",
            "textcolor":"black",
            "title":" ",
            "width":"5",
            "x":"0",
            "y":"0"
        },
        "14":
        {
            "bordercolor":"rgba(230, 110, 250, 1)",
            "color":"rgba(230, 110, 250, 0.2)",
            "height":"5",
            "imageurl":"",
            "textcolor":"black",
            "title":"",
            "width":"3",
            "x":"",
            "y":""
        },
        "17":
        {
            "bordercolor":"rgba(190, 190, 190, 0.2)",
            "color":"rgba(190, 190, 190, 0.2)",
            "height":"1",
            "imageurl":"",
            "textcolor":"black",
            "title":"",
            "width":"1",
            "x":"",
            "y":""
        },
        "2":
        {
            "bordercolor":"rgba(230, 110, 250, 1)",
            "color":"rgba(230, 110, 250, 0.2)",
            "height":"4",
            "imageurl":"image/KFC.png",
            "textcolor":"black",
            "title":"KFC",
            "width":"3",
            "x":"0",
            "y":"257"
        },
        "3":
        {
            "bordercolor":"rgba(220, 169, 105, 1)",
            "color":"rgba(230, 110, 250, 0.2)",
            "height":"2",
            "imageurl":"image/Nike.png",
            "textcolor":"black",
            "title":"Nike",
            "width":"4",
            "x":"0",
            "y":"0"
        },
        "5":
        {
            "bordercolor":"rgba(76, 181, 216, 1)",
            "color":"rgba(76, 181, 216, 0.2)",
            "height":"3",
            "imageurl":"image/Elevator.png",
            "textcolor":"black",
            "title":"Elevator",
            "width":"5",
            "x":"",
            "y":""
        }
    };

// 阻止滚动
// 一些移动设备有缺省的touchmove行为，比如说经典的iOS overscroll效果，当滚动超出了内容的界限时就引发视图反弹。
// 这种做法在许多多点触控应用中会带来混乱，但要禁用它很容易。
document.body.addEventListener('touchmove', function(event) {
    event.preventDefault();
}, false);

var mapData = new Array();
// 转化为二维数组
function mapDataTodyadicArray(){
    var indexX = 0;
    var indexY = 0;
    
    for (var i=0; i<map.width; i++){
        mapData[i]=new Array();  // 子数组
    }
    
    for (var i=0; i<map.data.length; i++){
        if (i%map.width==0&&i!=0){ // 换行
            indexX = 0; // 每次换行 x 从0 开始
            indexY ++;  // 每次换行 y + 1
        }else if(i!=0){
            indexX ++;
        }
        mapData[indexX][indexY]=map.data[i];
    }
}
// 初始化 数组
mapDataTodyadicArray();



var zoomScale = 1;

var imgX=0;
var imgY=0;

var gWinHeight = document.body.clientHeight;
var gWinWidth = document.body.clientWidth;

// 我的位置
var myPositionW = 269;
var myPositionH = 113;

window.addEventListener("orientationchange", function(event){
    if ( window.orientation == 180 || window.orientation==0 ) {
    //        alert("竖屏");
    gWinHeight = document.body.clientHeight;
    gWinWidth = document.body.clientWidth;
    }
    if( window.orientation == 90 || window.orientation == -90 ) {
    //        alert("横屏");
    gWinHeight = document.body.clientHeight;
    gWinWidth = document.body.clientWidth;
    }
    // yly 添加宽度和高度
    canvas.width=gWinWidth;
    canvas.height=gWinHeight;
    drawImage();
});

var canvas = document.getElementById("canvas");
// yly 添加宽度和高度
canvas.width=gWinWidth;
canvas.height=gWinHeight;
canvas.addEventListener("touchstart", touchstart, false);
canvas.addEventListener("touchmove", touchmove, false);
canvas.addEventListener("touchend", touchUp, false);
//        document.body.addEventListener("touchcancel", touchUp, false);
var context2D = canvas.getContext("2d");

var W = 32;    //每一块地图块的宽
var H = 32;    //每一块地图块的高
var l = 0;
var t = 0;
//for (var i=0; i<map.data.length; i++){
//    
//    l = i%map.width*W;     //绘画每一块地图块的X坐标
//    if (i%map.width==0&&i!=0){     //当达到一行是换行，注意第一行是0%0=0；所以应去除第一行换行的情况
//        t+=H;              //绘画地图块的Y坐标
//    }
//    if (map.data[i]>0){     //当地图块的数据不为0时绘画地图块
////        ctx.fillStyle = "#0000ff";
////        ctx.fillRect(l, t, W, H);
//        var propertie=getProperties(map.data[i]-1);
//        if(propertie!=""){  // 属性图块
//            DrawBlock(l,t,propertie.width,propertie.height
//                      ,"",propertie.color,propertie.textcolor
//                      ,propertie.bordercolor,propertie.imageurl);
//        }
//        
//    }
//};
drawImage();

// 获取属性
function getProperties(pId){
    for (var key in properties){
//        alert(key+"***"+properties[key]+"***"+properties[key].bordercolor);
        if(pId == key){
            return properties[key];
        }
    }
    return "";
};

function DrawBlock(x, y, width, height, text, backgroudcolor, textcolor, bordercolor, imageurl){
//    var canvas = document.getElementById("canvas");
//    var context2D = canvas.getContext("2d");
    //    var textsize = width * height / (1000 * zoomScale * zoomScale);
//    var textsize = width;
    var textsize = width * height / (1000 * zoomScale);
//    document.getElementById("ylyTest").value=textsize+"**"+zoomScale+"**"+width;
    context2D.fillStyle = backgroudcolor;
    context2D.fillRect(x, y, width, height);
    context2D.strokeStyle = bordercolor;
//    if(backgroudcolor=="rgba(190, 190, 190, 0.2)"){
//        alert(bordercolor+"**"+context2D.strokeStyle);
//    }
    context2D.lineWidth = 0.8;
    context2D.strokeRect(x, y, width, height);
    context2D.fillStyle = textcolor;
    if (textsize > 10) {
//    if (textsize > 80) {
//        context2D.font = 20 * zoomScale + "pt Microsoft YaHei";
        context2D.font = 10 * zoomScale + "pt Microsoft YaHei"
        if (imageurl != ""&&imageurl != " ") {
//            var image = new Image();
//            image.src = imageurl;
//            context2D.drawImage(image, x + width / 7, y + height / 2 - 25 * zoomScale, 30 * zoomScale, 30 * zoomScale);
            
            var image = new Image();
            image.onload=function(){
//                imgIsLoaded=true;
                context2D.drawImage(image, x + width / 7, y + height / 2 - 25 * zoomScale, 30 * zoomScale, 30 * zoomScale);
            }
            image.src = imageurl;
            
        }
    } else {
        context2D.font = 0 + "pt Microsoft YaHei";
    }
//    context2D.font = 10 * zoomScale + "pt Microsoft YaHei";
//    if (imageurl != ""&&imageurl != " ") {
//        var image = new Image();
//        image.src = imageurl;
//        context2D.drawImage(image, x + width / 7, y + height / 2 - 25 * zoomScale, 30 * zoomScale, 30 * zoomScale);
//    }
    context2D.fillText(text, x + width / 7 + 40 * zoomScale, y + height / 2);
};
var tsX,tsY;
function touchstart(event) {
    if (event.targetTouches.length == 1) {
        var touch = event.targetTouches[0];
        tsX = touch.pageX;
        tsY = touch.pageY;
        
//        document.getElementById("ylyTest").value += "**"+tsX;
        
        isDestination(tsX,tsY); // 是否是目的地
        isMyPosition(tsX,tsY); // 是否是我的位置
        
//        var myPoint = clientRectToCanvas01(myPositionW,myPositionH,W*zoomScale,H*zoomScale,imgX,imgY);
//        
//                var myTouch = clientRectToCanvas01(tsX,tsY,W*zoomScale,H*zoomScale,imgX,imgY);
        
//        var myPoint = clientRectToCanvas01(myPositionW,myPositionH,width,height,imgX,imgY);
        
//        context2D.fillRect((myPoint.x-imgX), (myPoint.y-imgY), 35, 35);
        
        
//        context2D.fillRect(myTouch.x, myTouch.y, 35, 35);
//        context2D.fillRect(myPoint.x, myPoint.y, 35, 35);
        
        
//        document.getElementById("txtAdresse").value +=(myTouch.x-imgX)+"**"+myTouch.y+"=="+imgX+"**"+imgY
//        +"=="+myPoint.x+"**"+myPoint.y;
//        document.getElementById("txtAdresse").value +=myPoint.x+"**"+W*zoomScale+"**"+myPoint.y+"**"+H*zoomScale+"==";
//                document.getElementById("txtAdresse").value +=myTouch.x+"**"+"**"+myTouch.y+"**"+imgX+"**"+imgY+"==";
        
    }
}
function touchmove(event) {
    if (event.targetTouches.length == 1) {
        
        var touch = event.targetTouches[0];

        var pos=windowToCanvas(canvas,tsX,tsY);
        canvas.style.cursor="move";
        var pos1=windowToCanvas(canvas,touch.pageX,touch.pageY);
        var x=pos1.x-pos.x;
        var y=pos1.y-pos.y;
        pos=pos1;
        imgX+=x;
        imgY+=y;
        
        drawImage();
//        document.getElementById("ylyTest").value+="**"+imgX;
        
        // 每次绘制完成之后 初始化地图坐标
        tsX = touch.pageX;
        tsY = touch.pageY;
    }
}

// 触摸结束
function touchUp(event){

}

function windowToCanvas(canvas,x,y){
    var bbox = canvas.getBoundingClientRect();
    return {
    x:x - bbox.left - (bbox.width - canvas.width) / 2,
    y:y - bbox.top - (bbox.height - canvas.height) / 2
    };
}

// 放大
function zoomIn(){
    zoomScale*=1.1;
//    imgX+=10;
//    imgY+=10;
//    W*=zoomScale;
//    H*=zoomScale;
    drawImage();
}
// 缩小
function zoomOut(){
    zoomScale/=1.1;
//    imgX+=10;
//    imgY+=10;
//    W*=zoomScale;
//    H*=zoomScale;
    drawImage();
}
var mapPoi = "../html/image/map_poi.png";
var lstMyPosition = new Array();
function drawImage(){
    l = 0;
    t = 0;
//    document.getElementById("ylyTest").value="";
//    document.getElementById("ylyTest").value+="2";
    context2D.clearRect(0, 0, canvas.width, canvas.height);
//    document.getElementById("ylyTest").value+="1";
    
    var tiledW = W*zoomScale;
    var tiledH = H*zoomScale;
    
    for (var i=0; i<map.data.length; i++){
        
//        l = i%map.width*W;     //绘画每一块地图块的X坐标
        l = i%map.width*tiledW;     //绘画每一块地图块的X坐标
        if (i%map.width==0&&i!=0){     //当达到一行是换行，注意第一行是0%0=0；所以应去除第一行换行的情况
//            t+=H;              //绘画地图块的Y坐标
            t+=tiledH;              //绘画地图块的Y坐标
//            document.getElementById("ylyTest").value="1";
        }
        if (map.data[i]>0){     //当地图块的数据不为0时绘画地图块
            //        ctx.fillStyle = "#0000ff";
            //        ctx.fillRect(l, t, W, H);

            
            var propertie=getProperties(map.data[i]-1);
            if(propertie!=""){  // 属性图块
//                document.getElementById("ylyTest").value+=i;
                
                if(map.data[i]-1 == 17){
                    
                    //                    console.log(propertie.bordercolor);
                                        console.log(propertie);
                }
                
                
                DrawBlock((l+imgX), t+imgY,propertie.width*tiledW
                          ,propertie.height*tiledH
                          ,propertie.title,propertie.color,propertie.textcolor
                          ,propertie.bordercolor,propertie.imageurl);
                // 搜索目的地
                var destinations = document.getElementById("txtAdresse").value;
                // 是否是目的地
                if(destinations!=""&&destinations!=null){
                    if(propertie.title.indexOf(destinations) >= 0){
                        DrawAddresse((l+imgX), t+imgY,propertie.width*tiledW
                                     ,propertie.height*tiledH
                                     ,propertie.title,propertie.color,propertie.textcolor
                                     ,propertie.bordercolor,mapPoi,map.data[i],i);
                    }
                }
            }
//            document.getElementById("ylyTest").value="2";
            
        }
    };
    
    drawPath(); // 绘制路径
    
    drawMyPosition(tiledW,tiledH); // 我的位置
    
};



// 绘制我的位置
function drawMyPosition(tiledW, tiledH){
    
    // 我的位置
//    var mpw = Math.floor(myPositionW/W)*width+imgX;
//    var mph = Math.floor(myPositionH/H)*height+imgY;
    
    var myPoint = clientRectToCanvas01(myPositionW,myPositionH,tiledW,tiledH,imgX,imgY);
    
    var imageAddresse = new Image();
    imageAddresse.onload=function(){
//        context2D.drawImage(imageAddresse,515,0,35,35, mpw + width / 2, mph + height / 2, 35, 35);
//        document.getElementById("txtAdresse").value =myPoint.x+"**"+"**"+myPoint.y+"**"+width+"**"+height+"**"+imgX+"**"+imgY+"==";
        
        lstMyPosition.length=0;
        lstMyPosition.push(saveAddresseToList(myPoint.x, myPoint.y,tiledW,tiledH,imgX,imgY,0));
        context2D.drawImage(imageAddresse,515,0,35,35, myPoint.x, myPoint.y + H*zoomScale/2, 35, 35);

    }
    imageAddresse.src = "image/map_poi.png";
}

// 可见的窗体大小转行为 画布位置
function clientRectToCanvas01(pointX,pointY,tiledW,tiledH,deviationX,deviationY){
    return {
    x:(Math.floor(pointX/W)*tiledW+deviationX),
    y:(Math.floor(pointY/H)*tiledH+deviationY)
    };
}

// 是否是我的位置
function isMyPosition(pointX,pointY){
    //    alert(lstMyPosition.length);
    //    alert(lstMyPosition[0].pointX<=pointX);
    //    alert(pointX<=lstMyPosition[0].pointX+30);
    //            alert(lstMyPosition[0].pointX+"**"+pointX+"**"+(lstMyPosition[0].pointX+30)+"=="+lstMyPosition[0].pointY+"**"+pointY);
    if(lstMyPosition.length>0&&(lstMyPosition[0].pointX<=pointX&&pointX<=lstMyPosition[0].pointX+35)
       &&(lstMyPosition[0].pointY+H*zoomScale/2<=pointY&&pointY<=lstMyPosition[0].pointY+35+H*zoomScale/2)){
        
        alert(lstMyPosition[0].id);
    }
}








